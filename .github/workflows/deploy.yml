name: Deploy resources
on: 
  workflow_dispatch:
    inputs:
      environment:
        required: false
        type: choice
        options:
          - dev
          - prod
        default: "dev"
      destroy_after_deploy:
        required: false
        type: boolean
        default: false
      destroy_only:
        required: false
        type: boolean
        default: false
      skip_terraform_apply:
        required: false
        type: boolean
        default: false
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    uses: ./.github/workflows/full-terraform-worker.yml
    secrets: inherit
    with:
      environment: ${{ inputs.environment }}
      destroy_after_deploy: ${{ inputs.destroy_after_deploy }}
      destroy_only: ${{ inputs.destroy_only }}
      skip_terraform_apply: ${{ inputs.skip_terraform_apply }}

  config:
    needs: deploy
    if: ${{ inputs.destroy_only == false }}
    uses: ./.github/workflows/ansible-configure-server-worker.yml
    secrets: inherit
    with:
      vm_ip: ${{ needs.deploy.outputs.vm_ip }}
      nsg_name: ${{ needs.deploy.outputs.nsg_name }}
      rg_name: ${{ needs.deploy.outputs.rg_name }}
  
